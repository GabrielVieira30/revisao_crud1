<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban - Gerenciamento de Tarefas</title>
    <link rel="stylesheet" href="../assets/style.css">
</head>
<body>
    <nav>
        <a href="user_register.php">Cadastrar Usu√°rio</a>
        <a href="task_register.php">Cadastrar Tarefa</a>
        <a href="index.html">Gerenciar Tarefas</a>
    </nav>
    <h1>Kanban - Gerenciamento de Tarefas</h1>
    <div class="kanban-board">
        <div class="kanban-column" id="a fazer">
            <h2>A Fazer</h2>
            <div id="a fazerTasks"></div>
        </div>
        <div class="kanban-column" id="fazendo">
            <h2>Fazendo</h2>
            <div id="fazendoTasks"></div>
        </div>
        <div class="kanban-column" id="pronto">
            <h2>Pronto</h2>
            <div id="prontoTasks"></div>
        </div>
    </div>
    <div id="holidays-widget" class="holidays-widget">
        <button id="holidays-toggle">üìÖ Feriados</button>
        <div id="holidays-panel" class="holidays-panel">
            <h3>Feriados de <?php echo date('Y'); ?></h3>
            <select id="country-select">
                <option value="BR">Brasil</option>
                <option value="US">Estados Unidos</option>
                <option value="PT">Portugal</option>
                <option value="ES">Espanha</option>
                <option value="FR">Fran√ßa</option>
                <option value="DE">Alemanha</option>
                <option value="IT">It√°lia</option>
                <option value="JP">Jap√£o</option>
                <option value="CN">China</option>
                <option value="IN">√çndia</option>
            </select>
            <div id="holidays-list"></div>
        </div>
    </div>
    <div id="pokemon-widget" class="pokemon-widget">
        <button id="pokemon-toggle">üêæ Pok√©mon</button>
        <div id="pokemon-panel" class="pokemon-panel">
            <h3>Pok√©mon Aleat√≥rio</h3>
            <button id="fetch-pokemon">Buscar Pok√©mon</button>
            <div id="pokemon-info"></div>
        </div>
    </div>
    <script>
        async function fetchTasks() {
            const res = await fetch('../api/read.php');
            tasks = await res.json();
            renderTasks();
        }

        function renderTasks() {
            ['a fazer', 'fazendo', 'pronto'].forEach(status => {
                document.getElementById(status + 'Tasks').innerHTML = '';
            });
            tasks.forEach((task) => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task';
                taskDiv.innerHTML = `
                    <div><strong>${task.descricao}</strong></div>
                    <div>Setor: ${task.setor}</div>
                    <div>Prioridade: ${task.prioridade}</div>
                    <div>Usu√°rio: ${task.usuario_nome}</div>
                    <div class="actions">
                        ${task.status !== 'a fazer' ? `<button onclick="moveTask(${task.id}, 'back')">‚Üê</button>` : ''}
                        ${task.status !== 'pronto' ? `<button onclick="moveTask(${task.id}, 'forward')">‚Üí</button>` : ''}
                        <button onclick="editTask(${task.id})">‚úé</button>
                        <button onclick="deleteTask(${task.id})">üóëÔ∏è</button>
                    </div>
                `;
                document.getElementById(task.status + 'Tasks').appendChild(taskDiv);
            });
        }

        async function moveTask(id, direction) {
            const statuses = ['a fazer', 'fazendo', 'pronto'];
            const task = tasks.find(t => t.id == id);
            let current = statuses.indexOf(task.status);
            let newStatus = task.status;
            if (direction === 'forward' && current < 2) newStatus = statuses[current + 1];
            if (direction === 'back' && current > 0) newStatus = statuses[current - 1];
            await fetch('../api/update.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${id}&usuario_id=${task.usuario_id}&descricao=${encodeURIComponent(task.descricao)}&setor=${encodeURIComponent(task.setor)}&prioridade=${encodeURIComponent(task.prioridade)}&status=${newStatus}`
            });
            fetchTasks();
        }

        async function deleteTask(id) {
            if (confirm('Excluir esta tarefa?')) {
                await fetch('../api/delete.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${id}`
                });
                fetchTasks();
            }
        }

        function editTask(id) {
            window.location.href = `task_register.php?id=${id}`;
        }

        let tasks = [];
        fetchTasks();

        // Holidays widget
        let holidaysVisible = false;
        document.getElementById('holidays-toggle').addEventListener('click', toggleHolidays);

        async function toggleHolidays() {
            const panel = document.getElementById('holidays-panel');
            if (!holidaysVisible) {
                await fetchHolidays();
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
            holidaysVisible = !holidaysVisible;
        }

        async function fetchHolidays() {
            try {
                const country = document.getElementById('country-select').value;
                const res = await fetch(`../api/holidays.php?country=${country}`);
                const holidays = await res.json();
                if (holidays.error) {
                    document.getElementById('holidays-list').innerHTML = '<p>Erro ao carregar feriados.</p>';
                    return;
                }
                const list = holidays.map(h => `<div>${h.date} - ${h.localName || h.name}</div>`).join('');
                document.getElementById('holidays-list').innerHTML = list;
            } catch (error) {
                document.getElementById('holidays-list').innerHTML = '<p>Erro ao carregar feriados.</p>';
            }
        }

        // Update holidays when country changes
        document.getElementById('country-select').addEventListener('change', () => {
            if (holidaysVisible) {
                fetchHolidays();
            }
        });

        // Pokemon widget
        let pokemonVisible = false;
        document.getElementById('pokemon-toggle').addEventListener('click', togglePokemon);
        document.getElementById('fetch-pokemon').addEventListener('click', fetchPokemon);

        async function togglePokemon() {
            const panel = document.getElementById('pokemon-panel');
            if (!pokemonVisible) {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
            pokemonVisible = !pokemonVisible;
        }

        async function fetchPokemon() {
            try {
                const randomId = Math.floor(Math.random() * 1010) + 1; // Pokemon IDs from 1 to 1010
                const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${randomId}`);
                const pokemon = await res.json();
                const types = pokemon.types.map(t => t.type.name).join(', ');
                document.getElementById('pokemon-info').innerHTML = `
                    <h4>${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)}</h4>
                    <img src="${pokemon.sprites.front_default}" alt="${pokemon.name}" style="width: 100px; height: 100px;">
                    <p>Tipos: ${types}</p>
                    <p>Altura: ${pokemon.height / 10} m</p>
                    <p>Peso: ${pokemon.weight / 10} kg</p>
                `;
            } catch (error) {
                document.getElementById('pokemon-info').innerHTML = '<p>Erro ao carregar Pok√©mon.</p>';
            }
        }
    </script>
</body>
</html>
